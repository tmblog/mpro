{% extends "base.html" %}

{% block title %}Dining Settings{% endblock %}

{% block content %}
<div class="dining-container mt-2">
    <!-- Header -->
    <div class="dining-header">
        <h5>{{ back_link|safe }} Restaurant Settings</h5>
    </div>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs dining-tabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tablesTab" type="button">
                <i class="bi bi-grid-3x3-gap-fill"></i> Rooms & Tables
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#orderingTab" type="button">
                <i class="bi bi-bag-check"></i> Ordering Methods
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settingsTab" type="button">
                <i class="bi bi-gear"></i> System Settings
            </button>
        </li>
        <li class="nav-item">
            <a href="{{ url_for('pos.admin_guest_tracking') }}" class="nav-link">
                <i class="bi bi-people-fill"></i> Guest Tracking
            </a>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content tab-content-wrapper">
        
        <!-- ROOMS & TABLES TAB -->
        <div class="tab-pane fade show active" id="tablesTab">
            <div class="split-section">
                <!-- Left: Room Management -->
                <div class="split-left">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 fw-bold">
                            <i class="bi bi-building text-primary"></i> Rooms / Areas
                        </h6>
                        <button class="btn btn-primary btn-sm" onclick="showAddRoomModal()">
                            <i class="bi bi-plus-lg"></i> Add Room
                        </button>
                    </div>
                    
                    <div id="roomsContainer">
                        {% if rooms %}
                            {% for room in rooms %}
                            <div class="room-card room-item" data-room-id="{{ room.room_id }}">
                                <span class="room-handle">
                                    <i class="bi bi-grip-vertical"></i>
                                </span>
                                <span class="room-name">{{ room.room_label }}</span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary btn-sm" 
                                            onclick="showEditRoomModal({{ room.room_id }}, '{{ room.room_label }}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" 
                                            onclick="deleteRoom({{ room.room_id }}, '{{ room.room_label }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state" id="noRoomsMsg">
                                <i class="bi bi-building"></i>
                                <p class="mb-0">No rooms created yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Right: Tables -->
                <div class="split-right">
                    <!-- Add Table Form -->
                    <div class="add-table-form">
                        <h6><i class="bi bi-plus-circle"></i> Add New Table</h6>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-5">
                                <label class="form-label small text-muted mb-1">Room</label>
                                <select id="tableRoom" class="form-select" {% if not rooms %}disabled{% endif %}>
                                    <option value="">Select Room...</option>
                                    {% for room in rooms %}
                                        <option value="{{ room.room_id }}">{{ room.room_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small text-muted mb-1">Table Number</label>
                                <input type="text" id="tableNumber" class="form-control" 
                                       placeholder="e.g. 1, 2, A1..." {% if not rooms %}disabled{% endif %}>
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="saveTableBtn" class="btn btn-primary w-100" 
                                        onclick="saveTable()" {% if not rooms %}disabled{% endif %}>
                                    <i class="bi bi-plus-lg"></i> Add Table
                                </button>
                            </div>
                        </div>
                        {% if not rooms %}
                        <div class="alert alert-info mt-3 mb-0 py-2">
                            <small><i class="bi bi-info-circle"></i> Create a room first before adding tables.</small>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Tables by Room -->
                    <div id="dataContainer">
                        {% if tables_by_room %}
                            {% for room_label, room_tables in tables_by_room.items() %}
                            <div class="room-section" id="room-section-{{ room_tables[0].room_id if room_tables else '' }}">
                                <div class="room-section-header">
                                    <h6>{% if room_label %}{{ room_label }}{% else %}Unassigned{% endif %}</h6>
                                    <span class="badge bg-secondary">{{ room_tables|length }} tables</span>
                                </div>
                                <div class="table-grid" id="room-tables-{{ room_tables[0].room_id if room_tables else '' }}">
                                    {% for table in room_tables %}
                                    <div class="table-card {% if table.table_occupied %}occupied{% endif %}" 
                                         id="table-col-{{ table.table_id }}">
                                        <button class="btn btn-link btn-sm text-danger table-delete p-0" 
                                                onclick="deleteTable('{{ table.table_id }}', '{{ table.table_number }}')"
                                                {% if table.table_occupied %}disabled{% endif %}>
                                            <i class="bi bi-x-circle-fill"></i>
                                        </button>
                                        <div class="table-number">#{{ table.table_number }}</div>
                                        {% if table.table_occupied %}
                                            <span class="table-status in-use">In Use</span>
                                        {% else %}
                                            <span class="table-status available">Available</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state" id="noTablesMsg">
                                <i class="bi bi-grid-3x3"></i>
                                <p class="mb-0">No tables created yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ORDERING METHODS TAB -->
        <div class="tab-pane fade" id="orderingTab">
            <div class="row">
                {% for item in pos_methods %}
                <div class="col-lg-4 col-md-6">
                    <div class="method-card">
                        <div class="method-header">
                            <span class="method-name">
                                {% if item.method == 'dine' %}
                                    <i class="bi bi-cup-hot text-warning"></i>
                                {% elif item.method == 'takeaway' %}
                                    <i class="bi bi-bag text-success"></i>
                                {% elif item.method == 'delivery' %}
                                    <i class="bi bi-bicycle text-info"></i>
                                {% else %}
                                    <i class="bi bi-cart text-secondary"></i>
                                {% endif %}
                                {{ item.method }}
                            </span>
                            <div class="method-toggle btn-group btn-group-sm">
                                <input type="radio" class="btn-check on-off" name="{{ item.method }}" 
                                       id="{{ item.method }}" data-method="{{ item.method }}" value="on"
                                       {% if item.on == 1 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="{{ item.method }}">On</label>
                                
                                <input type="radio" class="btn-check on-off" name="{{ item.method }}" 
                                       id="disabled-{{ item.method }}" data-method="{{ item.method }}" value="off"
                                       {% if item.on == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-danger" for="disabled-{{ item.method }}">Off</label>
                            </div>
                        </div>
                        
                        <div class="method-options">
                            <div class="method-option-row">
                                <span class="method-option-label">Menu Display</span>
                                <div class="btn-group btn-group-sm">
                                    <input type="radio" class="btn-check menu-option" name="in-{{ item.method }}" 
                                           id="in-{{ item.method }}" data-method="{{ item.method }}" 
                                           data-property="menu" data-value="0"
                                           {% if item.menu == 0 %}checked{% endif %}>
                                    <label class="btn btn-outline-primary" for="in-{{ item.method }}">In Menu</label>
                                    
                                    <input type="radio" class="btn-check menu-option" name="in-{{ item.method }}" 
                                           id="out-{{ item.method }}" data-method="{{ item.method }}" 
                                           data-property="menu" data-value="1"
                                           {% if item.menu == 1 %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary" for="out-{{ item.method }}">Out Menu</label>
                                </div>
                            </div>
                            
                            {% if item.method == 'dine' %}
                            <div class="method-option-row">
                                <span class="method-option-label">Total Division Hint</span>
                                <div class="btn-group btn-group-sm">
                                    <input type="radio" class="btn-check" name="divisionHint" 
                                           id="divisionHint1" {% if division_hint %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary" for="divisionHint1">On</label>
                                    
                                    <input type="radio" class="btn-check" name="divisionHint" 
                                           id="divisionHint2" {% if not division_hint %}checked{% endif %}>
                                    <label class="btn btn-outline-dark" for="divisionHint2">Off</label>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- SYSTEM SETTINGS TAB -->
        <div class="tab-pane fade" id="settingsTab">
            <div class="row">
                <div class="col-lg-6">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h6><i class="bi bi-cash-coin"></i> Charges & Taxes</h6>
                        </div>
                        <div class="settings-card-body">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h6>Service Charge</h6>
                                    <small>Applies only to dine-in orders</small>
                                </div>
                                <div class="input-group" style="width: 180px;">
                                    <input type="number" class="form-control" id="serviceChargeInput" 
                                           value="{{ service_charge }}" onchange="setTwoNumberDecimal(event)" 
                                           min="0" max="100" step="0.5">
                                    <span class="input-group-text">%</span>
                                    <button class="btn btn-primary" type="button" onclick="saveServiceCharge()">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h6>VAT Rate</h6>
                                    <small>Applied to all orders</small>
                                </div>
                                <div class="input-group" style="width: 180px;">
                                    <input type="number" class="form-control" id="vatInput" 
                                           value="{{ vat_rate }}" onchange="setTwoNumberDecimal(event)" 
                                           min="0" max="100" step="0.5">
                                    <span class="input-group-text">%</span>
                                    <button class="btn btn-primary" type="button" onclick="saveVat()">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h6><i class="bi bi-sliders"></i> Interface Options</h6>
                        </div>
                        <div class="settings-card-body">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h6>Quick Cart Feature</h6>
                                    <small>Create takeaway cart by pressing "New"</small>
                                </div>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="quickCartradio" 
                                           id="quickCart1" {% if quick_cart %}checked{% endif %}>
                                    <label class="btn btn-outline-success" for="quickCart1">Enabled</label>
                                    
                                    <input type="radio" class="btn-check" name="quickCartradio" 
                                           id="quickCart2" {% if not quick_cart %}checked{% endif %}>
                                    <label class="btn btn-outline-danger" for="quickCart2">Disabled</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<!-- Room Modal -->
<div class="modal fade" id="roomModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roomModalTitle">Add Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editRoomId">
                <div class="mb-3">
                    <label for="roomLabelInput" class="form-label">Room / Area Name</label>
                    <input type="text" class="form-control" id="roomLabelInput" 
                           placeholder="e.g. Main, Patio, Bar, Garden">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRoom()">Save</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer %}
<script src="{{ url_for('static', filename='js/sweetalert.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sortable.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/pos.helpers.js') }}"></script>
<script>
let roomModal;

document.addEventListener('DOMContentLoaded', () => {
    roomModal = new bootstrap.Modal(document.getElementById('roomModal'));
    
    // Ordering method toggles
    document.querySelectorAll('.on-off').forEach(button => {
        button.addEventListener('click', function() {
            const method = this.dataset.method;
            const value = this.value === 'on' ? 1 : 0;

            fetch('/update_pos_method', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ method, value }),
            })
            .then(response => response.json())
            .then(data => showToast(method + " updated.", true))
            .catch(error => showToast('Error updating: ' + error.message, false));
        });
    });

    // Menu option toggles
    document.querySelectorAll('.menu-option').forEach(option => {
        option.addEventListener('click', function() {
            const method = this.dataset.method;
            const property = this.dataset.property;
            const value = parseInt(this.dataset.value);

            fetch('/update_pos_menu_option', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ method, property, value }),
            })
            .then(response => response.json())
            .then(data => showToast(method + " menu updated.", true))
            .catch(error => showToast('Error updating: ' + error.message, false));
        });
    });
    
    // Quick cart toggle
    document.querySelectorAll('input[name="quickCartradio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const quickCartEnabled = document.getElementById('quickCart1').checked;

            fetch('/update_quick_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quick_cart: quickCartEnabled })
            })
            .then(res => res.json())
            .then(data => showToast(data.success ? "Quick Cart updated" : "Failed to update", data.success));
        });
    });

    // Division hint toggle
    document.querySelectorAll('input[name="divisionHint"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const divisionHintEnabled = document.getElementById('divisionHint1').checked;

            fetch('/update_division_hint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ division_hint: divisionHintEnabled })
            })
            .then(res => res.json())
            .then(data => showToast(data.success ? "Division hint updated" : "Failed to update", data.success));
        });
    });
    
    // Room sortable
    const container = document.getElementById('roomsContainer');
    if (container && container.querySelector('.room-card')) {
        new Sortable(container, {
            animation: 150,
            handle: '.room-handle',
            ghostClass: 'bg-light',
            onEnd: saveRoomOrder
        });
    }
});

// ============================================
// ROOM FUNCTIONS
// ============================================

function showAddRoomModal() {
    document.getElementById('roomModalTitle').textContent = 'Add Room';
    document.getElementById('editRoomId').value = '';
    document.getElementById('roomLabelInput').value = '';
    roomModal.show();
}

function showEditRoomModal(roomId, roomLabel) {
    document.getElementById('roomModalTitle').textContent = 'Edit Room';
    document.getElementById('editRoomId').value = roomId;
    document.getElementById('roomLabelInput').value = roomLabel;
    roomModal.show();
}

function saveRoom() {
    const roomId = document.getElementById('editRoomId').value;
    const roomLabel = document.getElementById('roomLabelInput').value.trim();
    
    if (!roomLabel) {
        showToast('Please enter a room name', false);
        return;
    }
    
    const endpoint = roomId ? '/update_room' : '/add_room';
    const payload = roomId 
        ? { room_id: parseInt(roomId), room_label: roomLabel }
        : { room_label: roomLabel };
    
    fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            showToast(data.error, false);
        } else {
            showToast('Room saved successfully', true);
            roomModal.hide();
            location.reload();
        }
    })
    .catch(err => {
        showToast('Error saving room', false);
        console.error(err);
    });
}

function deleteRoom(roomId, roomLabel) {
    Swal.fire({
        title: 'Delete Room?',
        text: `Delete "${roomLabel}"? This cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/delete_room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, false);
                } else {
                    showToast('Room deleted', true);
                    location.reload();
                }
            })
            .catch(err => {
                showToast('Error deleting room', false);
            });
        }
    });
}

function saveRoomOrder() {
    const roomItems = document.querySelectorAll('.room-item');
    const roomOrders = [];
    
    roomItems.forEach((item, index) => {
        roomOrders.push({
            room_id: parseInt(item.dataset.roomId),
            room_order: index
        });
    });
    
    fetch('/update_room_order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rooms: roomOrders })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            showToast(data.error, false);
        } else {
            showToast('Room order saved', true);
        }
    });
}

// ============================================
// TABLE FUNCTIONS
// ============================================

function deleteTable(id, tableNumber) {
    Swal.fire({
        title: 'Delete Table?',
        text: `Remove table #${tableNumber}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/delete_dining_table', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_id: id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, false);
                } else {
                    const tableCard = document.getElementById(`table-col-${id}`);
                    if (tableCard) {
                        const grid = tableCard.parentElement;
                        tableCard.remove();
                        
                        // Update badge count
                        const section = grid.closest('.room-section');
                        if (section) {
                            const badge = section.querySelector('.badge');
                            const remaining = grid.children.length;
                            if (badge) badge.textContent = `${remaining} tables`;
                            
                            if (remaining === 0) section.remove();
                        }
                        
                        // Show empty state if no tables
                        const container = document.getElementById('dataContainer');
                        if (container && !container.querySelector('.table-card')) {
                            container.innerHTML = `
                                <div class="empty-state" id="noTablesMsg">
                                    <i class="bi bi-grid-3x3"></i>
                                    <p class="mb-0">No tables created yet</p>
                                </div>
                            `;
                        }
                    }
                    showToast("Table deleted!", true);
                }
            });
        }
    });
}

function saveTable() {
    const roomSelect = document.getElementById('tableRoom');
    const tableNumberInput = document.getElementById('tableNumber');
    
    const roomId = roomSelect.value;
    const roomLabel = roomSelect.options[roomSelect.selectedIndex].text;
    const tableNumber = tableNumberInput.value.trim();
    
    if (!roomId) {
        showToast('Please select a room', false);
        roomSelect.focus();
        return;
    }
    
    if (!tableNumber) {
        showToast('Please enter a table number', false);
        tableNumberInput.focus();
        return;
    }

    fetch('/add_new_table', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tableNumber, roomId: parseInt(roomId) }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast(data.error, false);
        } else {
            showToast("Table saved!", true);
            appendTableToDOM(data.table_id, tableNumber, roomLabel, roomId);
            
            const currentNum = parseInt(tableNumber);
            tableNumberInput.value = !isNaN(currentNum) ? currentNum + 1 : '';
            tableNumberInput.focus();
        }
    });
}

function appendTableToDOM(tableId, tableNumber, roomLabel, roomId) {
    const container = document.getElementById('dataContainer');
    
    // Remove empty state
    const noTablesMsg = document.getElementById('noTablesMsg');
    if (noTablesMsg) noTablesMsg.remove();
    
    let roomSection = document.getElementById(`room-section-${roomId}`);
    
    if (!roomSection) {
        roomSection = document.createElement('div');
        roomSection.className = 'room-section';
        roomSection.id = `room-section-${roomId}`;
        roomSection.innerHTML = `
            <div class="room-section-header">
                <h6>${roomLabel}</h6>
                <span class="badge bg-secondary">0 tables</span>
            </div>
            <div class="table-grid" id="room-tables-${roomId}"></div>
        `;
        container.appendChild(roomSection);
    }
    
    const tablesGrid = document.getElementById(`room-tables-${roomId}`);
    const tableCard = document.createElement('div');
    tableCard.className = 'table-card';
    tableCard.id = `table-col-${tableId}`;
    tableCard.innerHTML = `
        <button class="btn btn-link btn-sm text-danger table-delete p-0" 
                onclick="deleteTable('${tableId}', '${tableNumber}')">
            <i class="bi bi-x-circle-fill"></i>
        </button>
        <div class="table-number">#${tableNumber}</div>
        <span class="table-status available">Available</span>
    `;
    tablesGrid.appendChild(tableCard);
    
    // Update badge
    const badge = roomSection.querySelector('.badge');
    if (badge) badge.textContent = `${tablesGrid.children.length} tables`;
}

// ============================================
// SETTINGS FUNCTIONS
// ============================================

function setTwoNumberDecimal(event) {
    event.target.value = parseFloat(event.target.value).toFixed(2);
}

function saveServiceCharge() {
    const value = document.getElementById('serviceChargeInput').value.trim();
    const serviceCharge = value === '' ? 0 : parseFloat(value);

    fetch('/update_service_charge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ serviceCharge })
    })
    .then(response => response.json())
    .then(() => showToast("Service charge updated!", true))
    .catch(() => showToast("Failed to update service charge.", false));
}

function saveVat() {
    const value = document.getElementById('vatInput').value.trim();
    const vat = value === '' ? 0 : parseFloat(value);

    fetch('/update_vat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vat })
    })
    .then(response => response.json())
    .then(() => showToast("VAT updated.", true))
    .catch(() => showToast("Failed to update VAT.", false));
}
</script>

{% endblock %}
